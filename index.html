
<!DOCTYPE html>
<html>
  <head>
    <title>Pythonをとりまく並行/非同期の話</title>
    <meta charset='utf-8'>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
  </head>
  <body style='display: none'>

  <div class="section" id="python">
<h1>Pythonをとりまく並行/非同期の話<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line">tell-k</div>
<div class="line">Pycon JP 2017</div>
</div>
<div class="section" id="id1">
<h2>で、誰？<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<img alt="https://pbs.twimg.com/profile_images/775582814871752704/J1TaucBz_400x400.jpg" src="https://pbs.twimg.com/profile_images/775582814871752704/J1TaucBz_400x400.jpg" />
<img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/vxjmiemo.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/vxjmiemo.png" />
<ul class="simple">
<li>tell-k</li>
<li>BeProud.inc</li>
<li>情弱プログラマー</li>
<li><a class="reference external" href="https://twitter.com/tell_k">https://twitter.com/tell_k</a></li>
<li><a class="reference external" href="https://tell-k.github.io/pyconjp2017/">https://tell-k.github.io/pyconjp2017/</a></li>
</ul>
</div>
<div class="section" id="beproud-inc-connpass">
<h2>Beproud.inc - connpass<a class="headerlink" href="#beproud-inc-connpass" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id42">
<img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/okbyv2hm.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/okbyv2hm.png" style="" />
<p class="caption"><span class="caption-text"><a class="reference external" href="http://connpass.com/">http://connpass.com/</a></span></p>
</div>
</div>
<div class="section" id="pyq-python">
<h2>PyQ - Pythonオンライン学習サービス<a class="headerlink" href="#pyq-python" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id43">
<a class="reference internal image-reference" href="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/4d694a2da10c437fa0a4b69901f9d754.png"><img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/4d694a2da10c437fa0a4b69901f9d754.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/4d694a2da10c437fa0a4b69901f9d754.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><a class="reference external" href="https://pyq.jp/">https://pyq.jp/</a></span></p>
</div>
</div>
<div class="section" id="pyq">
<h2>PyQ - 機械学習はじめました<a class="headerlink" href="#pyq" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<a class="reference internal image-reference" href="_images/nishio.png"><img alt="_images/nishio.png" src="_images/nishio.png" style="width: 70%;" /></a>
</div>
</div>
<div class="section" id="id2">
<h2>目的/動機<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>並行/並列処理とか非同期処理ってなんかいろいろ選択肢がよくある</li>
<li>普段、断片的に使ったり見たりしてもすぐに忘却してしまう</li>
<li>基本的なトピックとかライブラリとか押さえておきたい</li>
<li>Output を Follow しようと思いました</li>
<li><strong>Output を Follow しようと思いました</strong></li>
</ul>
</div>
<div class="section" id="id3">
<h2>対象<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Pythonは一通り書けるけど、並行/並列処理とかはあまりよく分からない</li>
<li>「やだ！あたしのPython時間かかる！」とお嘆きの方</li>
</ul>
</div>
<div class="section" id="id4">
<h2>目標<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="https://pbs.twimg.com/media/CTBnrdoUcAACGqL.jpg"><img alt="https://pbs.twimg.com/media/CTBnrdoUcAACGqL.jpg" src="https://pbs.twimg.com/media/CTBnrdoUcAACGqL.jpg" style="width: 80%;" /></a>
</div>
<div class="section" id="id5">
<h2>前提<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>サンプルコードは Python3.6 です</li>
<li>分散システムとかジョブキューとかそういう話はしません</li>
<li>ライブラリのがっつりした使い方も説明しません</li>
</ul>
</div>
<div class="section" id="id6">
<h2>目次<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>並行/並列処理</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>並行/並列処理とは?</li>
<li>負荷の種類</li>
<li>マルチスレッド/マルチプロセス</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>非同期I/O</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>コルーチン/イベントループ/I/O多重化</li>
<li>Pythonの非同期ライブラリ</li>
<li>asyncioの話</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>まとめ</li>
</ul>
</div>
<div class="section" id="id7">
<h2>並行/並列処理とは?<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id8">
<h2>並行/並列処理とは?<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>並行(<code class="docutils literal"><span class="pre">concurrent</span></code>)と並列(<code class="docutils literal"><span class="pre">parallel</span></code>)という似た用語がある</li>
<li><code class="docutils literal"><span class="pre">同義</span></code> として使われることも多い</li>
<li>一体どう違うんでしょうか？</li>
</ul>
</div>
<div class="section" id="id9">
<h2>並行/並列処理とは?<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ここでは <a class="reference external" href="https://www.amazon.co.jp/dp/4873114357">並列コンピューティング技法</a> より定義を拝借</li>
<li>システムが複数の動作を <code class="docutils literal"><span class="pre">実行状態に保てる</span></code> ことを並行(<code class="docutils literal"><span class="pre">concurrent</span></code>)と呼ぶ</li>
<li>複数の動作を <code class="docutils literal"><span class="pre">同時に実行できる</span></code> ことを並列(<code class="docutils literal"><span class="pre">parallel</span></code>)と呼ぶ</li>
<li>並行 は 並列を <code class="docutils literal"><span class="pre">包含</span></code> する概念である</li>
</ul>
<p>雑に言うと</p>
<ul class="simple">
<li>本当に複数の処理を同時に実行するのが -&gt; <code class="docutils literal"><span class="pre">並列処理</span></code></li>
<li>複数処理を効率良く切り替えながらあたかも同時に実行するのが -&gt; <code class="docutils literal"><span class="pre">並行処理</span></code></li>
</ul>
</div>
<div class="section" id="id11">
<h2>負荷の種類<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id12">
<h2>負荷の種類<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>そもそもプログラムのボトルネックとなる処理にはどういうものがあるのか?</li>
<li>大別して2種類ある</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>数値計算のようにCPUを使い続けるような処理 … <code class="docutils literal"><span class="pre">CPUバウンド</span></code></li>
<li>ファイルの読み書き、DBへの接続、ネットワーク通信 … <code class="docutils literal"><span class="pre">I/Oバウンド</span></code></li>
</ul>
</div></blockquote>
<ul class="simple">
<li>どちらの負荷なのかによって並行処理の取るべき手段が変わる</li>
<li>次に実際にPythonで並行/並列処理を書いてみましょう</li>
</ul>
</div>
<div class="section" id="concurrent-futures">
<h2>concurrent.futures<a class="headerlink" href="#concurrent-futures" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id13">
<h2>concurrent.futures<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python3.2 から追加された並行/並列処理用のライブラリ</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-3148/#future-objects">PEP 3148 – futures - execute computations asynchronously</a></li>
<li>以前からあった <a class="reference external" href="https://docs.python.org/ja/3/library/threading.html">threading</a> 、<a class="reference external" href="https://docs.python.org/ja/3/library/multiprocessing.html">multiprocessing</a> をより使いやすい統一したAPIを提供</li>
<li>ここで紹介するのは二つ</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>マルチスレッドを扱う <code class="docutils literal"><span class="pre">ThreadPoolExecuter</span></code></li>
<li>マルチプロセスを扱う <code class="docutils literal"><span class="pre">ProcessPoolExecuter</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="threadpoolexecuter">
<h2>ThreadPoolExecuter<a class="headerlink" href="#threadpoolexecuter" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>マルチスレッドのタスクの管理と実行をしてくれるライブラリ</li>
<li>複数スレッドを生成し並行に処理を実行する</li>
<li>I/Oバウンドな処理に向いている</li>
</ul>
<p>例えば</p>
<ul class="simple">
<li>スレッドを <strong>3つ</strong> 用意して</li>
<li><strong>巨大なファイルを読み込む</strong> タスクを <strong>6つ</strong> 並行に走らせる</li>
</ul>
<p>というの考える</p>
</div>
<div class="section" id="threadpoolexecuter-i-o">
<h2>ThreadPoolExecuter - I/Oバウンドの例<a class="headerlink" href="#threadpoolexecuter-i-o" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>

<span class="k">def</span> <span class="nf">busy_io</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="c1"># 巨大なファイルを読み込む</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;large{}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;Finish thread{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker_num</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># ワーカースレッド数</span>
    <span class="n">task_num</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># 実行タスク数</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">worker_num</span><span class="p">)</span> <span class="k">as</span> <span class="n">executer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">task_num</span><span class="p">):</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executer</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">busy_io</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="c1"># 実行が終わったものから結果を表示</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id14">
<h2>ThreadPoolExecuter - I/Oバウンドの例<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p>実行するとどうなるか?</p>
<ul class="simple">
<li>巨大なファイルを読み込んでる <code class="docutils literal"><span class="pre">I/O待ち</span></code> が発生する</li>
<li>I/O待ちが発生すると、別のスレッドの処理が実行される</li>
<li>結果、ほぼ同時に3つのファイル読み込み処理が開始</li>
<li>ワーカースレッドに空きができたら、未処理のタスクを実行する</li>
<li>逐次処理で6回読む込みよりも <code class="docutils literal"><span class="pre">処理速度はかなり速くなる</span></code></li>
</ul>
</div>
<div class="section" id="id15">
<h2>ThreadPoolExecuter - I/Oバウンドの例<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/multithred_iobound.png"><img alt="_images/multithred_iobound.png" src="_images/multithred_iobound.png" style="width: 85%;" /></a>
</div>
<div class="section" id="threadpoolexecuter-cpu">
<h2>ThreadPoolExecuter - CPUバウンドの例<a class="headerlink" href="#threadpoolexecuter-cpu" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>次に同じThreadPoolExecuterで <code class="docutils literal"><span class="pre">CPUバウンドな処理</span></code> を実行してみましょう</li>
</ul>
<p>例えば</p>
<ul class="simple">
<li>スレッドを <strong>3つ</strong> 用意</li>
<li><strong>大きな計算をする</strong> タスク を <strong>6つ</strong> 並行に走らせる</li>
</ul>
<p>というのを考える</p>
</div>
<div class="section" id="id16">
<h2>ThreadPoolExecuter - CPUバウンドの例<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>

<span class="k">def</span> <span class="nf">busy_cpu</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="c1"># 大きめの計算処理をする</span>
    <span class="nb">sum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Finish thread{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker_num</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># ワーカースレッド数</span>
    <span class="n">task_num</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># 実行タスク数</span>

    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">worker_num</span><span class="p">)</span> <span class="k">as</span> <span class="n">executer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">task_num</span><span class="p">):</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executer</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">busy_cpu</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="c1"># 実行が終わったのものから結果を表示</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id17">
<h2>ThreadPoolExecuter - CPUバウンドの例<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<p>実行するとどうなるか？</p>
<ul class="simple">
<li>I/Oバウンドな処理と違い、CPUバウンドな処理は逐次的に1タスクづつ実行される</li>
</ul>
<p>なぜ？</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">GIL</span></code> という仕組みにより、実行されるスレッドは <code class="docutils literal"><span class="pre">常に一つ</span></code> に制限されている</li>
</ul>
<p>結果的に</p>
<ul class="simple">
<li>逐次処理で実行するのと、ほぼ <code class="docutils literal"><span class="pre">処理時間は変わらない</span></code></li>
<li>つまりCPUバウンドな処理をマルチスレッドにしてもあまり嬉しくない</li>
</ul>
</div>
<div class="section" id="id18">
<h2>ThreadPoolExecuter - CPUバウンドの例<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/multithred_cpubound.png"><img alt="_images/multithred_cpubound.png" src="_images/multithred_cpubound.png" style="width: 85%;" /></a>
</div>
<div class="section" id="gil">
<h2>GILとは？<a class="headerlink" href="#gil" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Global</span> <span class="pre">Interpretor</span> <span class="pre">Lock</span></code> の 略称</li>
<li>Pythonのコードを実行できるスレッドは <code class="docutils literal"><span class="pre">常に一つのみ</span></code> という制限</li>
</ul>
<p>なぜ制限あるのか？</p>
<ul class="simple">
<li>CPythonがスレッドセーフではないCライブラリに依存しているから</li>
<li>つまりPythonが安全にスレッドを利用するために必要な仕組み</li>
</ul>
<p>ちなみに</p>
<ul class="simple">
<li>I/O処理や、一部のC拡張モジュールなどでは <code class="docutils literal"><span class="pre">GILが解放される</span></code> らしいです</li>
<li><a class="reference external" href="https://docs.python.org/ja/3/glossary.html#term-global-interpreter-lock">用語集 &gt; global interpreter lock</a></li>
<li><a class="reference external" href="http://methane.hatenablog.jp/entry/20111203/1322900647">Python3 Advent Calender 3日目 - New GIL を理解する</a></li>
</ul>
</div>
<div class="section" id="id19">
<h2>GIL解放なんてできるの？<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>解放の仕方はドキュメントに書いてある</li>
<li><a class="reference external" href="https://docs.python.org/ja/3.6/c-api/init.html#releasing-the-gil-from-extension-code">拡張コード内でGILを解放する</a></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>注釈
GIL を解放するのはほとんどがシステムのI/O関数を呼び出す時ですが、メモリバッファに対する圧縮や
暗号化のように、Pythonのオブジェクトにアクセスしない長時間かかる計算処理を呼び出すときもGIL
を解放することは有益です。例えば、 zlib や hashlib モジュールは圧縮やハッシュ計算の前にGILを解放します。
</pre></div>
</div>
<ul class="simple">
<li>pandas は Cython を 利用して一部の処理をGIL解放している</li>
<li><a class="reference external" href="https://www.anaconda.com/blog/developer-blog/pandas-releasing-gil/">Pandas Releasing GIL</a></li>
</ul>
</div>
<div class="section" id="cpu">
<h2>CPUバウンドな処理を並列にするには？<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">マルチプロセス</span></code> で <code class="docutils literal"><span class="pre">並列</span></code> に実行する</li>
<li>つまり、複数プロセスが独立してタスクを実行するという事</li>
</ul>
<p>注意点</p>
<ul class="simple">
<li>同時に実行できるのは、CPUコア数分のみ</li>
<li>それ以上はワーカー数(プロセス数)を増やしてもあまり意味はない</li>
</ul>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># コア数を確かめる時は？</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="processpoolexecuter-cpu">
<h2>ProcessPoolExecuter - CPUバウンドな例<a class="headerlink" href="#processpoolexecuter-cpu" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>

<span class="k">def</span> <span class="nf">busy_cpu</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="c1"># 大きめの計算処理をする</span>
    <span class="nb">sum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Finish process{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker_num</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># ワーカープロセス数</span>
    <span class="n">task_num</span> <span class="o">=</span> <span class="mi">6</span>    <span class="c1"># 実行タスク数</span>

    <span class="c1"># ProcessPoolExecuterに変えるだけで良い</span>
    <span class="k">with</span> <span class="n">ProcesssPoolExecutor</span><span class="p">(</span><span class="n">worker_num</span><span class="p">)</span> <span class="k">as</span> <span class="n">executer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">task_num</span><span class="p">):</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">executer</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">busy_cpu</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>

    <span class="c1"># 実行が終わったのから結果を表示</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id21">
<h2>ProcessPoolExecuter - CPUバウンド<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/multiprocess_cpubound.png"><img alt="_images/multiprocess_cpubound.png" src="_images/multiprocess_cpubound.png" style="width: 80%;" /></a>
</div>
<div class="section" id="id22">
<h2>ProcessPoolExecuter - CPUバウンド<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<p>もしCPUが2コアしかなかったら?</p>
<a class="reference internal image-reference" href="_images/multiprocess_out_of_core.png"><img alt="_images/multiprocess_out_of_core.png" src="_images/multiprocess_out_of_core.png" style="width: 70%;" /></a>
</div>
<div class="section" id="id23">
<h2>マルチスレッド - メリット・デメリット<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>メリット</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>I/Oバウンドな処理には効果的</li>
<li>プロセスに比べて起動コストが低い</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>デメリット</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>GILがあるためCPUバウンドな処理には不向き</li>
<li>スレッド間でのデータ競合を気をつけなければいけない</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id24">
<h2>マルプロセス - メリット・デメリット<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>メリット</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>GILの影響を受けずに並列に処理することができる</li>
<li>メモリ空間を別プロセスと共有しない</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>デメリット</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>CPUのコア数を超えて並列化はできない</li>
<li>スレッドよりもメモリを消費する</li>
<li>プロセス間通信しないとデータを受け渡せない</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id25">
<h2>シングルスレッドでの処理効率の要求<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>かつてWebサーバの <a class="reference external" href="http://www.hyuki.com/yukiwiki/wiki.cgi?TheC10kProblem">C10K問題（クライアント1万台問題）</a> というものがあった</li>
<li>プロセス数やスレッド数が増えすぎると、メモリを食いつぶしたり、コンテキストスイッチするコストが増大してサーバがパンクしてしまうという問題</li>
<li>この頃から、シングルスレッドでもより多くの処理を捌くことが要求されるようになった</li>
<li>その辺から出てきたのが次の <code class="docutils literal"><span class="pre">非同期I/O</span></code> です</li>
</ul>
</div>
<div class="section" id="i-o">
<h2>非同期I/O<a class="headerlink" href="#i-o" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id26">
<h2>非同期I/O<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>基本的にI/O処理中はプログラムはブロックされる</li>
<li>これを <code class="docutils literal"><span class="pre">同期I/O(ブロッキングI/O)</span></code> と呼ぶ</li>
<li>対してブロックしないようにI/O処理することを <code class="docutils literal"><span class="pre">非同期I/O(ノンブロッキングI/O)</span></code> と呼ぶ</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>より正確には <code class="docutils literal"><span class="pre">ノンブロッキングI/O</span></code> と <code class="docutils literal"><span class="pre">非同期I/O</span></code> は定義が異なる</li>
<li><a class="reference external" href="http://blog.takanabe.tokyo/2015/03/26/240/">ノンブロッキングI/Oと非同期I/Oの違いを理解する</a></li>
</ul>
</div></blockquote>
<ul class="simple">
<li>非同期処理で頻繁に利用される技術を紹介</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">イベントループ</span></code></li>
<li><code class="docutils literal"><span class="pre">I/O多重化</span></code></li>
<li><code class="docutils literal"><span class="pre">コルーチン</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id27">
<h2>イベントループ<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">イベント駆動プログラミング</span></code></li>
<li>イベントを監視するためのループが <code class="docutils literal"><span class="pre">イベントループ</span></code> である</li>
</ul>
<p>どんな事をするのか？</p>
<ul class="simple">
<li>事前にイベントに対応する <code class="docutils literal"><span class="pre">イベントハンドラ</span></code> を <code class="docutils literal"><span class="pre">イベントループ</span></code> に登録</li>
<li>イベントが発生したら <code class="docutils literal"><span class="pre">イベントキュー</span></code> に入れて管理</li>
<li><code class="docutils literal"><span class="pre">イベントディスパッチャー</span></code> が <code class="docutils literal"><span class="pre">イベントハンドラ</span></code> を実行する</li>
</ul>
<p>どんなのがイベント？</p>
<ul class="simple">
<li>ファイルが読み書きできる</li>
<li>ソケットが読み取り可能になる</li>
<li>タイマーに設定したタイミング</li>
<li>シグナルを受け取る</li>
</ul>
</div>
<div class="section" id="id28">
<h2>イベントループ<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/event_loop.png"><img alt="_images/event_loop.png" src="_images/event_loop.png" style="width: 95%;" /></a>
</div>
<div class="section" id="id29">
<h2>I/O多重化<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>シングルスレッドで複数のI/O(ファイル・ディスクリプタ)を扱う必要がある</li>
<li>UNIX系ではI/O多重化して管理するシステムコール(select/epoll/kqueue)を主に利用</li>
<li>WindowsではIOCPという同種のAPIを利用する</li>
</ul>
<p>主にイベントループのライブラリが内部で</p>
<ul class="simple">
<li>I/O多重化のライブラリを利用して、I/Oのイベントを監視している</li>
<li>プラットフォームに適したもの自動で利用してくれる</li>
</ul>
</div>
<div class="section" id="id30">
<h2>コルーチン<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>処理を任意のタイミングで中断/再開できる機能</li>
<li>Pythonではジェネレータの拡張構文として実装されている</li>
<li><code class="docutils literal"><span class="pre">ジェネレータベースのコルーチン</span></code></li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0342/">PEP 342 – Coroutines via Enhanced Generators</a></li>
</ul>
</div>
<div class="section" id="id31">
<h2>ジェネレーターベースのコルーチン<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">coro</span><span class="p">():</span>
    <span class="n">world</span> <span class="o">=</span> <span class="k">yield</span> <span class="s2">&quot;Hello&quot;</span>
    <span class="k">yield</span> <span class="n">world</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">coro</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1"># =&gt; &lt;generator object coro at 0x10f2df620&gt;</span>

<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>  <span class="c1"># =&gt; Hello</span>

<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;World&#39;</span><span class="p">))</span> <span class="c1"># =&gt; World</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id32">
<h2>非同期ライブラリ<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python には以前から非同期プログラミングをサポートするライブラリが多数あった</li>
<li>どのライブラリも、先にあげた技術的要素を独自に実装していました</li>
<li>結果、同じ非同期処理でも各ライブラリに合わせた実装しなければならなかった</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ライブラリ名</td>
<td>イベントループ</td>
<td>コルーチン</td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://www.gevent.org/">gevent</a></td>
<td><a class="reference external" href="http://software.schmorp.de/pkg/libev.html">libev</a></td>
<td><a class="reference external" href="http://greenlet.readthedocs.io/en/latest/">greentlet</a></td>
</tr>
<tr class="row-odd"><td><a class="reference external" href="http://twistedmatrix.com/documents/current/">Twisted</a></td>
<td><a class="reference external" href="https://twistedmatrix.com/documents/current/api/twisted.internet.reactor.html">reactor</a></td>
<td><a class="reference external" href="https://twistedmatrix.com/documents/current/api/twisted.internet.defer.html#inlineCallbacks">inlineCallbacks</a></td>
</tr>
<tr class="row-even"><td><a class="reference external" href="http://www.tornadoweb.org/en/stable/">Tornado</a></td>
<td><a class="reference external" href="http://www.tornadoweb.org/en/stable/gen.html#tornado.gen.coroutine">tornado.gen.coroutine</a></td>
<td><a class="reference external" href="http://www.tornadoweb.org/en/stable/ioloop.html#tornado.ioloop">tornado.ioloop</a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id33">
<h2>たくさんフレンズがいるのは良いことだが・・・<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<a class="reference internal image-reference" href="_images/friends.png"><img alt="_images/friends.png" src="_images/friends.png" style="width: 50%;" /></a>
</div>
</div>
<div class="section" id="asyncio">
<h2>asyncio<a class="headerlink" href="#asyncio" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python自身が公式に非同期I/Oのための共通のコンポーネント群を用意</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-3156/">PEP 3156 – Asynchronous IO Support Rebooted: the “asyncio” Module</a></li>
<li>Python3.4 から <a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> モジュールが追加</li>
<li>Python3.5 から <code class="docutils literal"><span class="pre">async/await</span></code> (ネイティブコルーチン) が利用可能になった</li>
</ul>
</div>
<div class="section" id="async-await">
<h2>async/await<a class="headerlink" href="#async-await" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python3.5 からは <code class="docutils literal"><span class="pre">asyn/await構文</span></code> (<code class="docutils literal"><span class="pre">ネイティブコルーチン</span></code>) が使える</li>
</ul>
<p>Python 3.4 以前</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Python 3.5 以降</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id35">
<h2>asyncio 挙動の確認<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>コルーチンをチェーンする公式のサンプル</li>
</ul>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Compute </span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">print_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="n">compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">print_sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id36">
<h2>asyncio 挙動の確認<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="https://docs.python.org/ja/3/_images/tulip_coro.png"><img alt="https://docs.python.org/ja/3/_images/tulip_coro.png" src="https://docs.python.org/ja/3/_images/tulip_coro.png" style="width: 90%;" /></a>
<p><a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#example-chain-coroutines">https://docs.python.org/3/library/asyncio-task.html#example-chain-coroutines</a></p>
</div>
<div class="section" id="asyncio-1">
<h2>asyncioへの対応(1)<a class="headerlink" href="#asyncio-1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>基本的にはasyncioを使うように対応する必要がある</li>
<li>ライブラリは <a class="reference external" href="https://github.com/aio-libs">https://github.com/aio-libs</a> にまとまっている</li>
</ul>
<p>普段に使うようなライブラリの置き換え</p>
<ul class="simple">
<li>aiohttp(<a class="reference external" href="http://aiohttp.readthedocs.io/en/stable/">http://aiohttp.readthedocs.io/en/stable/</a>)</li>
<li>aioredis(<a class="reference external" href="http://aioredis.readthedocs.io/en/v0.3.3/">http://aioredis.readthedocs.io/en/v0.3.3/</a>)</li>
<li>aiormysql(<a class="reference external" href="https://github.com/aio-libs/aiomysql">https://github.com/aio-libs/aiomysql</a>)</li>
</ul>
</div>
<div class="section" id="asyncio-2">
<h2>asyncioへの対応(2)<a class="headerlink" href="#asyncio-2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>既存のライブラリ群も asyncio 対応していっている</li>
</ul>
<p>非同期系だと</p>
<ul class="simple">
<li>tornado の <a class="reference external" href="http://www.tornadoweb.org/en/stable/asyncio.html">tornado.platform.asyncio</a>  で asyncioのイベントループが使えたり</li>
<li>Twisted で <a class="reference external" href="https://twistedmatrix.com/documents/16.4.1/core/howto/defer-intro.html#coroutines-with-async-await">async/await</a> が使えたり</li>
</ul>
</div>
<div class="section" id="asyncio-3">
<h2>asyncioへの対応(3)<a class="headerlink" href="#asyncio-3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://uvloop.readthedocs.io/">http://uvloop.readthedocs.io/</a></li>
<li>libuv + Cython で高速化したイベントループ</li>
<li>asyncio のイベントループポリシーを差し替えるだけで使える</li>
<li>コードはそのままにパフォーマンスを向上できる</li>
</ul>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">uvloop</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop_policy</span><span class="p">(</span><span class="n">uvloop</span><span class="o">.</span><span class="n">EventLoopPolicy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id38">
<h2>まとめ - 並行/並列処理<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>並行は並列を包含する概念</li>
<li>マルチスレッドはI/Oバウンドには効果あり</li>
<li>マルチスレッドはGILがあるのでCPUバウンドには効果なし</li>
<li>並列処理をしたいのであればマルチプロセスが良い</li>
<li>C10K問題くらいからシングルスレッドでも非同期処理が必要になった</li>
</ul>
</div>
<div class="section" id="id39">
<h2>まとめ - 非同期I/O<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>シングルスレッドで非同期処理</li>
<li>イベントループ/IO多重化/コルーチンという技術要素で実現</li>
<li>Pythonの非同期ライブラリ</li>
<li>asyncioの誕生の背景と概要</li>
<li>今後は各種ライブラリがもっとasyncioに対応していくでしょう</li>
</ul>
</div>
<div class="section" id="id40">
<h2>感謝<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h2>
<p>忙しい中、レビューしてくださった。&#64;shimizukawaさん、&#64;crochacoさん、&#64;mahataさん、&#64;kamekoさん ありがとうございました。</p>
<p>また参考にさせていただいた資料、本の著者の皆さま。本当ににありがとうございました。</p>
</div>
<div class="section" id="id41">
<h2>ご静聴ありがとうございました<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h2>
</div>
</div>

  <!--
  <div id="help">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
  </div>
  -->
  </body>
  <script type="text/javascript" src="_static/js/initialize.js?faefefa"></script>
  <script type="text/javascript" src="_static/js/slides.js?1fhafaefaaeaefefaeafffa"></script>
</html>
